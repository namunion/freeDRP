name: Build & Upload Ubuntu QCOW2 Image with Tailscale

on:
  workflow_dispatch:

jobs:
  build-qcow2:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install qemu & cloud utils
        run: |
          sudo apt update
          sudo apt install -y qemu-utils cloud-utils genisoimage libguestfs-tools

      - name: Create base qcow2 image
        run: |
          IMAGE_NAME="ubuntu-custom.qcow2"
          BASE_IMAGE="https://cloud-images.ubuntu.com/noble/current/noble-server-cloudimg-amd64.img"
          wget -O base.img "$BASE_IMAGE"
          cp base.img "$IMAGE_NAME"

          echo "✅ Base image downloaded and copied"

      - name: Inject SSH public key
        run: |
          mkdir -p /tmp/cloud-init
          cat <<EOF > /tmp/cloud-init/user-data
          #cloud-config
          users:
            - name: ubuntu
              sudo: ALL=(ALL) NOPASSWD:ALL
              ssh_authorized_keys:
                - ${{ secrets.SSH_PUB_KEY }}
          packages:
            - tailscale
          runcmd:
            - systemctl enable tailscaled
            - systemctl start tailscaled
            - tailscale up --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} --hostname=gh-qcow2
          EOF

          cat <<EOF > /tmp/cloud-init/meta-data
          instance-id: qcow2-instance
          local-hostname: ubuntu-qcow2
          EOF

          genisoimage -output /tmp/seed.iso -volid cidata -joliet -rock /tmp/cloud-init/user-data /tmp/cloud-init/meta-data

      - name: Combine qcow2 + cloud-init ISO
        run: |
          virt-customize -a ubuntu-custom.qcow2 \
            --run-command 'echo "Image customization started..."'

          qemu-img info ubuntu-custom.qcow2

      - name: Compress image
        run: |
          qemu-img convert -O qcow2 -c ubuntu-custom.qcow2 ubuntu-custom-compressed.qcow2
          ls -lh ubuntu-custom-compressed.qcow2

      - name: Upload qcow2 artifact
        uses: actions/upload-artifact@v4
        with:
          name: ubuntu-qcow2-image
          path: ubuntu-custom-compressed.qcow2

      - name: Done message
        run: echo "✅ Build completed! Download artifact from workflow summary."

